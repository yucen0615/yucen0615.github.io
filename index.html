<!doctype html>
<html lang="zh-Hant" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>課業行事曆</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>
  <style>
    input:focus, select:focus, button:focus { outline: none; box-shadow: none; border-color: #999; }
    .dark input:focus, .dark select:focus { border-color: #666; }
    body { transition: background 0.3s, color 0.3s; }
    .card { background:#ffffff; padding:1.5rem; border-radius:1rem; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
    .dark .card { background:#000000; color:#f3f4f6; }
    .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
    .calendar-day { background:#fff; height:110px; padding:6px; border-radius:8px; cursor:pointer; display:flex; flex-direction:column; overflow:hidden; }

/* 隱藏事項區 scrollbar（仍可滑動） */
.calendar-day > div::-webkit-scrollbar{ display:none; }
.calendar-day > div{ scrollbar-width:none; -ms-overflow-style:none; }
    .dark .calendar-day { background:#1a1a1a; color:#f3f4f6; }
    .calendar-day:hover { background:#e5e5e5; }
    .dark .calendar-day:hover { background:#333; }
    .date { font-weight:bold; display:inline-flex; align-items:center; justify-content:center; padding:2px 6px; border-radius:9999px; cursor:pointer; transition: background-color 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease; }
    .date:hover{ background:#e5e5e5; transform: translateY(-1px); box-shadow: 0 0 0 2px rgba(0,0,0,0.25); }
    .dark .date:hover{ background:#333; box-shadow: 0 0 0 2px rgba(255,255,255,0.35); }
    .event { font-size:0.75rem; margin-top:4px; padding:2px 6px; border-radius:6px; display:flex; align-items:center; gap:4px; transition: background-color 0.12s ease, transform 0.12s ease, box-shadow 0.12s ease; }
    .event:hover{ transform: translateY(-1px); box-shadow:0 2px 4px rgba(0,0,0,0.12); }
    .dark .event:hover{ box-shadow:0 2px 6px rgba(0,0,0,0.45); }
    .event::before{ content:''; width:6px; height:6px; border-radius:50%; display:inline-block; }
    .homework{ background:#D6E4FF; color:#1E3A8A; }
    .homework::before{ background:#4F7DF3; }
    .exam{ background:#EFC7D5; color:#6B1F38; }
    .exam::before{ background:#C13F6A; }
    .dark .homework{ background:#2B3F87; color:#EAF0FF; }
    .dark .homework::before{ background:#8DA2FB; }
    .dark .exam{ background:#7A2942; color:#FFE9F1; }
    .dark .exam::before{ background:#F2A0B8; }
    .btn { background:#555; color:white; padding:6px 12px; border-radius:8px; }
    #eventModal { display:none; }
    #eventModal.show { display:flex; }
  </style>
</head>
<body class="bg-white dark:bg-black min-h-screen">
<header class="max-w-5xl mx-auto p-6 flex justify-between">
  <h1 class="text-xl font-semibold">課業行事曆</h1>
  <button id="toggleDark" class="btn"><span id="modeLabel"></span></button>
</header>

<main class="max-w-5xl mx-auto p-6">
  <!-- 月曆視圖 -->
  <section id="monthView" class="card">
    <div class="flex justify-between mb-2">
      <button id="prevMonth" class="btn">上個月</button>
      <div id="monthLabel"></div>
      <button id="nextMonth" class="btn">下個月</button>
    </div>
    <div class="grid grid-cols-7 text-center font-bold">
      <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
    </div>
    <div id="calendarGrid" class="calendar-grid mt-2"></div>
  </section>

  <!-- 單日視圖（第二階段） -->
  <section id="dayView" class="card hidden">
    <div class="flex items-center justify-between mb-4">
      <button id="backToMonth" class="btn">← 返回月曆</button>
      <div id="dayLabel" class="font-semibold"></div>
      <div></div>
    </div>

    <!-- 整天事項 -->
    <div id="allDayEvents" class="mb-4"></div>

    <!-- 時間軸 -->
    <div id="timeline" class="space-y-2"></div>
  </section>
</main>

<div id="eventModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
  <div class="bg-[#fafafa] dark:bg-[#111111] text-gray-900 dark:text-gray-100 p-6 rounded-3xl w-[380px] shadow-2xl">
    <h3 class="text-lg font-semibold mb-4">新增／編輯事件</h3>
    <input id="eventTitle" class="w-full p-3 rounded-xl mb-3 bg-[#f2f2f2] dark:bg-[#1f1f1f] border-none" placeholder="事件名稱" />
    <div class="flex items-center gap-3 mb-3">
      <span class="w-20 text-sm">類別</span>
      <select id="eventType" class="flex-1 p-3 rounded-xl bg-[#f2f2f2] dark:bg-[#1f1f1f] border-none">
        <option value="homework">作業</option>
        <option value="exam">考試</option>
      </select>
    </div>
    <div class="flex items-center gap-3 mb-3">
      <span class="w-20 text-sm">時間</span>
      <select id="eventMode" class="flex-1 p-3 rounded-xl bg-[#f2f2f2] dark:bg-[#1f1f1f] border-none">
        <option value="allday">整天</option>
        <option value="range">時段</option>
      </select>
    </div>
    <div id="timeRange" class="hidden flex gap-3 mb-3">
      <input id="startTime" type="time" class="flex-1 p-3 rounded-xl bg-[#f2f2f2] dark:bg-[#1f1f1f] border-none" />
      <input id="endTime" type="time" class="flex-1 p-3 rounded-xl bg-[#f2f2f2] dark:bg-[#1f1f1f] border-none" />
    </div>
    <div class="flex items-center gap-3 mb-4">
      <span class="w-20 text-sm">提醒</span>
      <input id="reminderValue" type="number" class="w-20 p-3 rounded-xl bg-[#f2f2f2] dark:bg-[#1f1f1f] border-none" placeholder="0" />
      <select id="reminderUnit" class="flex-1 p-3 rounded-xl bg-[#f2f2f2] dark:bg-[#1f1f1f] border-none">
        <option value="days">天前</option>
        <option value="hours">小時前</option>
      </select>
    </div>
    <div class="flex justify-end gap-3">
      <button id="deleteEvent" class="px-4 py-2 rounded-xl bg-red-200 dark:bg-[#4a1f1f] hidden">刪除</button>
      <button id="cancelEvent" class="px-4 py-2 rounded-xl bg-gray-200 dark:bg-[#2a2a2a]">取消</button>
      <button id="saveEvent" class="px-4 py-2 rounded-xl bg-gray-300 dark:bg-[#3a3a3a]">儲存</button>
    </div>
  </div>
</div>

<script>
const calendarGrid = document.getElementById('calendarGrid');
const monthLabel = document.getElementById('monthLabel');
const eventModal = document.getElementById('eventModal');
const eventTitle = document.getElementById('eventTitle');
const eventType = document.getElementById('eventType');
const eventMode = document.getElementById('eventMode');
const timeRange = document.getElementById('timeRange');
const startTime = document.getElementById('startTime');
const endTime = document.getElementById('endTime');
const reminderValue = document.getElementById('reminderValue');
const reminderUnit = document.getElementById('reminderUnit');
let current = new Date();
let editingId = null;
let selectedDate = null;
let events = JSON.parse(localStorage.getItem('events')||'[]');
function formatDate(d){ return d.toISOString().split('T')[0]; }

function renderCalendar(){
  calendarGrid.innerHTML='';
  const y=current.getFullYear(), m=current.getMonth();
  monthLabel.innerText=`${y} 年 ${m+1} 月`;
  const first=new Date(y,m,1).getDay();
  const last=new Date(y,m+1,0).getDate();
  for(let i=0;i<first;i++) calendarGrid.appendChild(document.createElement('div'));
  for(let d=1;d<=last;d++){
    const day=document.createElement('div');
    day.className='calendar-day';
    const dateObj = new Date(y,m,d);
    const dateStr=formatDate(dateObj);
    day.innerHTML=`<div class='date' data-date="${dateStr}">${d}</div>`;

    const eventContainer = document.createElement('div');
    eventContainer.className = 'mt-1 flex-1 overflow-y-auto';
    events.filter(e=>e.date===dateStr).forEach(e=>{
      if(!e.id) e.id = crypto.randomUUID();
      const ev=document.createElement('div');
      ev.className='event '+e.type;
      ev.innerText = e.mode==='range' && e.start ? `${e.start}–${e.end} ${e.title}` : e.title;
      ev.onclick=(evt)=>{
        evt.stopPropagation();
        editingId = e.id;
        selectedDate = e.date;
        eventTitle.value = e.title;
        eventType.value = e.type;
        eventMode.value = e.mode;
        startTime.value = e.start || '';
        endTime.value = e.end || '';
        reminderValue.value = e.reminder || '';
        reminderUnit.value = e.reminderUnit || 'days';
        timeRange.classList.toggle('hidden', e.mode !== 'range');
        document.getElementById('deleteEvent').classList.remove('hidden');
        eventModal.classList.add('show');
      };
      eventContainer.appendChild(ev);
    });

    // 點日期數字 → 進入單日視圖
    const dateEl = day.querySelector('.date');
    dateEl.onclick = (evt)=>{
      evt.stopPropagation();
      openDayView(dateObj);
    };

    // 點格子其他地方 → 新增事項
    day.onclick=()=>{
      selectedDate = dateStr;
      editingId = null;
      eventTitle.value = '';
      startTime.value = '';
      endTime.value = '';
      reminderValue.value = '';
      document.getElementById('deleteEvent').classList.add('hidden');
      eventModal.classList.add('show');
    };

    day.appendChild(eventContainer);

    calendarGrid.appendChild(day);
  }
}

eventMode.onchange = ()=>{ timeRange.classList.toggle('hidden', eventMode.value !== 'range'); };

document.getElementById('saveEvent').onclick=()=>{
  if(!eventTitle.value) return alert('請輸入名稱');
  if(editingId){
    const e = events.find(x=>x.id===editingId);
    Object.assign(e,{ title:eventTitle.value, type:eventType.value, mode:eventMode.value, start:startTime.value, end:endTime.value, reminder:reminderValue.value, reminderUnit:reminderUnit.value });
  }else{
    events.push({ id:crypto.randomUUID(), date:selectedDate, title:eventTitle.value, type:eventType.value, mode:eventMode.value, start:startTime.value, end:endTime.value, reminder: reminderValue.value, reminderUnit: reminderUnit.value });
  }
  localStorage.setItem('events',JSON.stringify(events));
  editingId=null;
  eventTitle.value=''; startTime.value=''; endTime.value=''; reminderValue.value='';
  document.getElementById('deleteEvent').classList.add('hidden');
  eventModal.classList.remove('show');
  renderCalendar();
};

document.getElementById('cancelEvent').onclick=()=>{
  editingId=null;
  document.getElementById('deleteEvent').classList.add('hidden');
  eventModal.classList.remove('show');
};

document.getElementById('deleteEvent').onclick=()=>{
  if(editingId){
    events = events.filter(e=>e.id!==editingId);
    localStorage.setItem('events',JSON.stringify(events));
  }
  editingId=null;
  document.getElementById('deleteEvent').classList.add('hidden');
  eventModal.classList.remove('show');
  renderCalendar();
};

document.getElementById('prevMonth').onclick=()=>{ current.setMonth(current.getMonth()-1); renderCalendar(); };
document.getElementById('nextMonth').onclick=()=>{ current.setMonth(current.getMonth()+1); renderCalendar(); };
const modeLabel = document.getElementById('modeLabel');
function updateModeLabel(){ modeLabel.innerText = document.documentElement.classList.contains('dark') ? '深色模式' : '淺色模式'; }
document.getElementById('toggleDark').onclick=()=>{ document.documentElement.classList.toggle('dark'); updateModeLabel(); };
updateModeLabel(); renderCalendar();

function scheduleReminders(){
  events.forEach(e=>{
    if(!e.reminder || e.reminder <= 0) return;
    let eventTime = new Date(e.date + 'T09:00');
    if(e.mode === 'range' && e.start){ eventTime = new Date(e.date + 'T' + e.start); }
    let remindMs = Number(e.reminder) * (e.reminderUnit === 'days' ? 86400000 : 3600000);
    let remindTime = eventTime.getTime() - remindMs;
    let delay = remindTime - Date.now();
    if(delay > 0){ setTimeout(()=>{ alert(`⏰ 提醒：${e.title}`); }, delay); }
  });
}

scheduleReminders();

// ===== 第二階段：單日時間軸 =====
const monthView = document.getElementById('monthView');
const dayView = document.getElementById('dayView');
const dayLabel = document.getElementById('dayLabel');
const allDayEvents = document.getElementById('allDayEvents');
const timeline = document.getElementById('timeline');

document.getElementById('backToMonth').onclick=()=>{
  dayView.classList.add('hidden');
  monthView.classList.remove('hidden');
};

function openDayView(dateObj){
  selectedDate = formatDate(dateObj);
  monthView.classList.add('hidden');
  dayView.classList.remove('hidden');
  dayLabel.innerText = `${dateObj.getFullYear()} 年 ${dateObj.getMonth()+1} 月 ${dateObj.getDate()} 日`;
  renderDayTimeline();
}

function renderDayTimeline(){
  allDayEvents.innerHTML = '';
  timeline.innerHTML = '';

  const dayEvents = events.filter(e=>e.date===selectedDate);

  // 整天事項
  dayEvents.filter(e=>e.mode==='allday').forEach(e=>{
    const div = document.createElement('div');
    div.className = 'event '+e.type;
    div.innerText = e.title;
    allDayEvents.appendChild(div);
  });

  // 時段事項（簡易時間軸）
  for(let h=0; h<24; h++){
    const row = document.createElement('div');
    row.className = 'flex items-start gap-3';
    row.innerHTML = `<div class="w-12 text-xs text-gray-500">${String(h).padStart(2,'0')}:00</div>`;

    const slot = document.createElement('div');
    slot.className = 'flex-1 min-h-[28px]';

    dayEvents.filter(e=>e.mode==='range' && e.start && parseInt(e.start.split(':')[0])===h)
      .forEach(e=>{
        const ev = document.createElement('div');
        ev.className = 'event '+e.type;
        ev.innerText = `${e.start}–${e.end} ${e.title}`;
        ev.onclick=()=>{
          editingId = e.id;
          eventTitle.value = e.title;
          eventType.value = e.type;
          eventMode.value = e.mode;
          startTime.value = e.start;
          endTime.value = e.end;
          reminderValue.value = e.reminder || '';
          reminderUnit.value = e.reminderUnit || 'days';
          timeRange.classList.remove('hidden');
          document.getElementById('deleteEvent').classList.remove('hidden');
          eventModal.classList.add('show');
        };
        slot.appendChild(ev);
      });

    row.appendChild(slot);
    timeline.appendChild(row);
  }
}

</script>
</body>
</html>
