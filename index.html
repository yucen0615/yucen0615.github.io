<!doctype html>
<html lang="zh-Hant" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>課業行事曆</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>
  <style>
    body { transition: background 0.3s, color 0.3s; }
    .card { background:#ffffff; shadow-md rounded-2xl p-6; transition: background 0.3s, color 0.3s; }
    .dark .card { background:#000000; color:#f3f4f6; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; background: #ffffff; border-radius: 0.5rem; overflow: hidden; }
    .dark .calendar-grid { background:#000000; }
    .calendar-day { background: #ffffff; color:#000000; min-height: 100px; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; position: relative; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
    .dark .calendar-day { background:#1a1a1a; color:#f3f4f6; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .calendar-day:hover { background:#e2e2e2; }
    .dark .calendar-day:hover { background:#333333; }
    .calendar-day .date { font-weight: bold; margin-bottom: 0.25rem; }
    .event { font-size: 0.75rem; margin-top: 2px; padding: 2px 4px; border-radius: 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.3s; }
    .event.homework { background: #D6A77A; color:#000; }
    .event.exam { background: #74B3CE; color:#000; }
    .event.reminder { background: #FF7F50; color: #000; font-weight: bold; }
    .dark .event.homework { background:#A57C5F; color:#fff; }
    .dark .event.exam { background:#5B9EB8; color:#fff; }
    .dark .event.reminder { background:#FF7F50; color:#fff; }
    .calendar-week { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: bold; padding-bottom: 4px; border-bottom: 1px solid #d1d5db; }
    .dark .calendar-week { border-color:#555555; }
    input, select, button { transition: all 0.2s; }
    button { cursor: pointer; }
    input:focus, select:focus { outline:none; border-color:#555555; box-shadow:0 0 0 2px rgba(85,85,85,0.3); }
    .dark input:focus, .dark select:focus { border-color:#888888; box-shadow:0 0 0 2px rgba(136,136,136,0.3); }
    .btn { background:#555555; color:white; padding:0.5rem 1rem; border-radius:0.5rem; transition: all 0.2s; }
    .btn:hover { background:#333333; }
    .dark .btn { background:#333333; color:white; }
    .dark .btn:hover { background:#555555; }
    .event-modal-text { color: #000; }
    .dark .event-modal-text { color: #f0f0f0; }
    .light-btn { background:#f3f3f3; color:#000; }
    .light-btn:hover { background:#e0e0e0; }
    .dark .light-btn { background:#555555; color:#fff; }
    .dark .light-btn:hover { background:#444444; }
    #eventModal { display: none; align-items: center; justify-content: center; }
    #eventModal.show { display: flex; }
    .dark #eventModal > div { background:#2a2a2a; }
  </style>
</head>
<body class="bg-white dark:bg-black text-gray-900 dark:text-gray-100 min-h-screen">
  <header class="max-w-5xl mx-auto p-6 flex items-center justify-between">
    <h1 class="text-xl font-semibold">課業行事曆</h1>
    <nav class="space-x-4 text-sm flex items-center gap-2">
      <a href="#calendar" class="hover:underline">月曆</a>
      <span id="darkStatus" class="text-sm font-medium">ON</span>
      <button id="toggleDark" class="btn">切換深色模式</button>
    </nav>
  </header>

  <main class="max-w-5xl mx-auto p-6 grid gap-6">
    <section id="calendar" class="card">
      <h3 class="text-lg font-semibold">月曆</h3>
      <div class="flex justify-between items-center mt-3 mb-2">
        <button id="prevMonth" class="btn">上個月</button>
        <div id="monthLabel" class="font-semibold"></div>
        <button id="nextMonth" class="btn">下個月</button>
      </div>
      <div class="calendar-week">
        <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
      </div>
      <div class="calendar-grid" id="calendarGrid"></div>
    </section>
  </main>

  <div id="eventModal" class="fixed inset-0 bg-black/50 hidden">
    <div class="bg-white dark:bg-gray-700 p-6 rounded-xl w-80 shadow-lg event-modal-text m-auto">
      <h4 class="text-lg font-semibold mb-2">新增/編輯事件</h4>
      <input id="eventTitle" type="text" class="w-full p-2 border rounded mt-1 event-modal-text dark:text-black" placeholder="事件名稱" />
      <div class="flex gap-2 mt-2">
        <label>類別:</label>
        <select id="eventType" class="p-2 border rounded event-modal-text dark:text-black">
          <option value="homework">作業</option>
          <option value="exam">考試</option>
        </select>
      </div>
      <div class="flex gap-2 mt-2">
        <label>時間模式:</label>
        <select id="eventMode" class="p-2 border rounded event-modal-text dark:text-black">
          <option value="allday">整天</option>
          <option value="range">時段</option>
        </select>
      </div>
      <div id="timeRange" class="hidden flex gap-2 mt-2">
        <input id="startTime" type="time" class="p-2 border rounded event-modal-text dark:text-black" />
        <input id="endTime" type="time" class="p-2 border rounded event-modal-text dark:text-black" />
      </div>
      <div class="flex gap-2 mt-2">
        <label>提醒:</label>
        <input id="reminderValue" type="number" class="p-2 border rounded w-24 event-modal-text dark:text-black" placeholder="數字" />
        <select id="reminderUnit" class="p-2 border rounded event-modal-text dark:text-black">
          <option value="days">天前</option>
          <option value="hours">小時前</option>
          <option value="seconds">秒前</option>
        </select>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="cancelEvent" class="btn light-btn">取消</button>
        <button id="addCalendarEvent" class="btn light-btn">新增/更新</button>
      </div>
    </div>
  </div>

  <script>
    const calendarGrid = document.getElementById('calendarGrid');
    const monthLabel = document.getElementById('monthLabel');
    const eventModal = document.getElementById('eventModal');
    const eventTitle = document.getElementById('eventTitle');
    const eventType = document.getElementById('eventType');
    const eventMode = document.getElementById('eventMode');
    const timeRange = document.getElementById('timeRange');
    const startTime = document.getElementById('startTime');
    const endTime = document.getElementById('endTime');
    const reminderValue = document.getElementById('reminderValue');
    const reminderUnit = document.getElementById('reminderUnit');
    const addCalendarEventBtn = document.getElementById('addCalendarEvent');
    const cancelEventBtn = document.getElementById('cancelEvent');
    const toggleDark = document.getElementById('toggleDark');
    const darkStatus = document.getElementById('darkStatus');

    let current = new Date();
    let selectedDate = null;
    let events = JSON.parse(localStorage.getItem('calendarEvents')||'[]');

    function renderCalendar(date){
      calendarGrid.innerHTML = '';
      const year = date.getFullYear();
      const month = date.getMonth();
      monthLabel.innerText = `${year} 年 ${month+1} 月`;
      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month+1, 0).getDate();
      for(let i=0;i<firstDay;i++) calendarGrid.appendChild(document.createElement('div'));
      for(let d=1; d<=lastDate; d++){
        const dayDiv = document.createElement('div');
        dayDiv.className='calendar-day';
        dayDiv.innerHTML=`<div class='date'>${d}</div>`;

        const dayEvents = events.filter(e=>e.date===formatDate(new Date(year,month,d)))
                               .sort((a,b)=> (a.mode==='allday'?0:1) - (b.mode==='allday'?0:1) || a.start.localeCompare(b.start));

        dayEvents.forEach((ev,index)=>{
          if(index>3) return; // 最多顯示前4個
          const evDiv = document.createElement('div');
          evDiv.className='event '+ev.type;
          if(ev.remVal>0){ evDiv.className='event reminder'; evDiv.style.background='#FF7F50'; evDiv.style.color='#fff'; }
          else {
            if(ev.type==='homework') { evDiv.style.background=document.documentElement.classList.contains('dark')?'#A57C5F':'#D6A77A'; evDiv.style.color=document.documentElement.classList.contains('dark')?'#fff':'#000'; }
            else { evDiv.style.background=document.documentElement.classList.contains('dark')?'#5B9EB8':'#74B3CE'; evDiv.style.color=document.documentElement.classList.contains('dark')?'#fff':'#000'; }
          }
          evDiv.innerText=ev.title + (ev.mode==='range'?` ${ev.start}-${ev.end}`:'');
          evDiv.addEventListener('click',(e)=>{
            e.stopPropagation();
            selectedDate=ev.date;
            openEventModal();
          });
          dayDiv.appendChild(evDiv);
        });

        dayDiv.addEventListener('click', ()=>{ selectedDate = formatDate(new Date(year,month,d)); openEventModal(); });
        dayDiv.addEventListener('dblclick', ()=>{
          // 打開詳細視窗顯示所有事件
          selectedDate = formatDate(new Date(year,month,d));
          openDetailedView(selectedDate);
        });

        calendarGrid.appendChild(dayDiv);
      }
    }

    function openDetailedView(date){
      const dayEvents = events.filter(e=>e.date===date).sort((a,b)=> (a.mode==='allday'?0:1) - (b.mode==='allday'?0:1) || a.start.localeCompare(b.start));
      const detailText = dayEvents.map(e=>`${e.mode==='allday'?'整天':'時段 '+e.start+'-'+e.end}: ${e.title} (${e.type==='homework'?'作業':'考試'})`).join('\n');
      alert(`查看 ${date} 所有事件:\n` + detailText);
    }

    function formatDate(d){ return d.toISOString().split('T')[0]; }
    function openEventModal(){ eventModal.classList.add('show'); }
    function closeEventModal(){ eventModal.classList.remove('show'); eventTitle.value=''; startTime.value=''; endTime.value=''; reminderValue.value=''; eventMode.value='allday'; timeRange.classList.add('hidden'); }

    eventMode.addEventListener('change', ()=>{ timeRange.classList.toggle('hidden', eventMode.value!=='range'); });
    addCalendarEventBtn.addEventListener('click', ()=>{
      if(!eventTitle.value || !selectedDate){ alert('請輸入事件名稱'); return; }
      const existingIndex = events.findIndex(e=>e.date===selectedDate && e.title===eventTitle.value);
      const ev = {title:eventTitle.value, date:selectedDate, type:eventType.value, mode:eventMode.value, start:startTime.value, end:endTime.value, remVal:Number(reminderValue.value), reminderUnit:reminderUnit.value};
      if(existingIndex>=0) events[existingIndex]=ev;
      else events.push(ev);
      localStorage.setItem('calendarEvents', JSON.stringify(events));
      renderCalendar(current);
      setReminder(ev);
      closeEventModal();
    });
    cancelEventBtn.addEventListener('click', closeEventModal);

    function setReminder(ev){
      if(ev.remVal>0){
        let ms=0;
        if(ev.reminderUnit==='days') ms=ev.remVal*24*60*60*1000;
        if(ev.reminderUnit==='hours') ms=ev.remVal*60*60*1000;
        if(ev.reminderUnit==='seconds') ms=ev.remVal*1000;
        const eventTime = new Date(ev.date+'T'+(ev.mode==='range'?ev.start:'00:00'));
        const delay = eventTime - Date.now() - ms;
        if(delay>0) setTimeout(()=>alert(`提醒：${ev.title} (${ev.type==='homework'?'作業':'考試'}) 即將開始`), delay);
      }
    }

    events.forEach(ev=>setReminder(ev));
    document.getElementById('prevMonth').addEventListener('click', ()=>{ current.setMonth(current.getMonth()-1); renderCalendar(current); });
    document.getElementById('nextMonth').addEventListener('click', ()=>{ current.setMonth(current.getMonth()+1); renderCalendar(current); });

    toggleDark.addEventListener('click', ()=>{ document.documentElement.classList.toggle('dark'); darkStatus.innerText = document.documentElement.classList.contains('dark') ? 'ON' : 'OFF'; });

    renderCalendar(current);
  </script>
</body>
</html>
